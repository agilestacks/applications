---
version: 1
kind: application
meta:
  name: nodejs-application:1
  brief: Nodejs Application
  source:
    dir: ./

requires:
  - kubernetes
  - aws

components:
- name: ecr
  source:
    dir: ./ecr

lifecycle:
  bare: allow
  verbs: [deploy, undeploy]
  order:
    - ecr
  mandatory:
    - ecr

parameters:
- name: application
  parameters:
  - name: name
    fromEnv: NAME
  - name: namespace
    fromEnv: NAMESPACE
  - name: replicas
    fromEnv: REPLICAS
  - name: version
    fromEnv: VERSION
  - name: ingress.host
    fromEnv: INGRESS_HOST
  - name: ingress.path
    fromEnv: INGRESS_PATH
    empty: allow
  - name: version
    fromEnv: VERSION
    value: latest
    empty: allow
- name: dns.domain
- name: component.ingress.fqdn
- name: cloud.region
- name: terraform.bucket
  parameters:
  - name: name
    fromEnv: STATE_BUCKET
  - name: region
    fromEnv: STATE_REGION
- name: component.ecr
  parameters:
  - name: image
  - name: name
    value: "${dns.domain}/${application.name}"

outputs:
- name: application.image
  value: ${component.ecr.image}
