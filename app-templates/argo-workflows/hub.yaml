---
version: 1
kind: application
meta:
  name: argo-workflows:1
  brief: >
    Argo worfklow application with minio bucket trigger and a GitHub
  source:
    dir: .

components:
- name: ecr
  source:
    dir: ../../../components/ecr
- name: github-repository
  source:
    dir: ../../components/github-repository
# - name: github-webhook
#   source:
#     dir: ../../components/github-webhook
- name: buildbox
  source:
    dir: ../../components/buildbox
- name: minio-bucket
  source:
    dir: ../../components/minio-bucket
# - name: argo-sensor-webhook
#   source:
#     dir: ../../components/argo-sensor-webhook
# - name: argo-sensor-artifact
#   source:
#     dir: ../../components/argo-sensor-artifact

lifecycle:
  bare: allow
  verbs: [deploy, undeploy]
  order:
    - ecr
    - github-repository
    - buildbox
    # - github-webhook
    - minio-bucket
    # - argo-sensor-artifact
  mandatory:
    - ecr
    - github-repository
    - buildbox
    # - github-webhook
    - minio-bucket
    # - argo-sensor-artifact

parameters:
- name: cloud.region
  value: us-east-1
- name: application
  parameters:
  - name: name
    value: antonargo1
  - name: webhook
    value: ${application.name}
  - name: namespace
    value: argoproj
    env: NAMESPACE
- name: dns.domain
  env: DOMAIN_NAME
- name: terraform.bucket
  parameters:
  - name: name
  - name: region
- name: component.ingress
  parameters:
  - name: protocol
  - name: urlPrefix
  - name: fqdn

- name: component.nats.fqdn
- name: component.minio
  parameters:
  - name: service.host
  - name: service.port
# - name: component.minio
#   parameters:
#   - name: endpoint
#   - name: endpoint.ingress
#   - name: namespace
#   - name: secret.name
#   - name: secret.accessKeyRef
#   - name: secret.secretKeyRef

- name: component.bucket
  parameters:
  - name: endpoint
  - name: name
    value: myapplication
  - name: namespace
  - name: secret.name
  - name: secret.namespace
  - name: secret.accessKeyRef
  - name: secret.secretKeyRef
- name: component.bucket
  component: argo-sensor-artifact
  parameters:
  - name: endpoint
    value: ${component.minio.service.host}:${component.minio.service.port}

- name: component.buildbox
  parameters:
  - name: directory
    value: .
  - name: dockerfile
    value: Dockerfile

- name: component.argo
  parameters:
  - name: namespace
  - name: sensor.subject
    value: bucketevents
  - name: sensor.name
    value: bucketsensor

- name: component.github
  parameters:
  - name: workspace
    value: ../../app-templates/argo-workflows
  - name: token
    fromEnv: GITHUB_TOKEN
  - name: repository.organization
    value: asibot
  - name: repository.name
    value: antonargo1
  - name: repository.description
    value: >
      Worfklow application template backed with Argo.
      Optimized to carry simulation and data science tasks
- name: component.ecr.name
  value: myargoapp.${dns.domain}
- name: component.git.remote

outputs:
- name: app.git.remote
  value: ${component.git.remote}

templates:
  files:
    - "*.template"
